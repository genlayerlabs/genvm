# GenVM
It is a monorepo for GenVM, which consists of the following subprojects:
- [executor](./executor/) core GenVM itself: modified [`wasmtime`](https://wasmtime.dev) which exposes genvm-sdk-wasi implementation and does all the sandboxing work
- [sdk-rust](./sdk-rust/): rust bindings for genvm-sdk-wasi, this library is autogenerated from [witx](./executor/src/wasi/witx/genlayer_sdk.witx)
- [runners](./runners/): various "runners" available for contracts to use
    - software floating point implementation
    - python interpreter with built-in `sdk-rust`
    - python standard library from genlayer

## Building

Prelude:
- `./tools/ya-build/ya-build config`
  This command scraps and configures all targets (similar to CMake)
- `ninja` is an alternative to `Makefile`, it runs build commands
- Output is located at `build/out` as a "root" (`bin`, `lib`, `share`)

Required tools:
- git
- ruby (3.\*, otherwise it will be installed from a script)
- [...](./build-scripts/src/ubuntu.sh) can be installed via scripts (see below)

Basic setup:
1. `cd $PROJECT_DIR`
2. `git submodule update --init --recursive --depth 1`
3. `./build-scripts/install-deps.rb --os`
4. `source env.sh`
5. `git third-party update --all`

### Simple

1. `./build-scripts/install-deps.rb --rust --genvm`
2. `ya-build config` (for release build pass `--preload .ci/release-conf.rb`)
3. `ninja -C build genvm/executor/all`
4. Get `genvm-runners.zip` from [github](https://github.com/yeagerai/genvm)
5. merge `build/out` and `genvm-runners.zip`

### Full

1. `./build-scripts/install-deps.rb --rust --genvm --runners`
2. `ya-build config` (for release build pass `--preload .ci/release-conf.rb`)
3. `ninja -C build tags/all`
4. full genvm (including runners) is located at `build/out`

## Running tests
As of now there are two test suites, both of which require `./build-scripts/install-deps.rb --test`

### executor/testdata (mock tests)
Prerequisites:
- For `get_webpage` tests to work, one needs a compatible webdriver. There is a docker image for simplification: `bash -c 'docker run --rm -d --network=host $(docker build -q -t genvm/modules-webdriver -f executor/modules/default-impl/web-funcs/webdriver.dockerfile executor/modules/default-impl/web-funcs/)'`
- For the default `call_llm` to work `OPENAIKEY` should be set to openai key

Generic steps:
```bash
### install dependencies (once)
python3 -m pip install -r executor/testdata/runner/requirements.txt
sudo apt-get install -y wabt
### run
./executor/testdata/runner/run.py
```

### python tests (module tests)
```bash
### install python 3.12
sudo apt install libsqlite3-dev
# ^ without sqlite-dev further won't have sqlite3 required by tests
curl https://pyenv.run | bash
~/.pyenv/bin/pyenv install 3.12
### install poetry
python3 -m pip install poetry
poetry env use ~/.pyenv/versions/3.12.5/bin/python3.12
### install dependencies (once)
cd runners/genlayer-std
poetry install
### run tests
poetry run pytest -n auto
```
