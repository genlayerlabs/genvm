# GenVM
It is a monorepo for GenVM, which consists of the following subprojects:
- [genvm](./genvm/) itself: modified [`wasmtime`](https://wasmtime.dev) which exposes genvm-sdk-wasi implementation and does all the sandboxing work
- [sdk-rust](./sdk-rust/): rust bindings for genvm-sdk-wasi, this library is autogenerated from [witx](./genvm/src/wasi/witx/genlayer_sdk.witx)
- [sdk-python](./sdk-python/):
    - Driver for slight [RustPython](https://github.com/RustPython/RustPython) modification that allows rustpython to work in sandboxed environment and patches some pieces of code to be compatible with typing from 3.12
    - bindings for genvm-sdk-wasi:
        - raw [`genlayer.wasi`](./sdk-python/src/pyimpl.rs) wrapped in rust and it's [python interface](./sdk-python/py-stub)
        - user-firendly [`genlayer.sdk`](./sdk-python/py/) in pure python

## Building

Required tools:
- git
- ruby 3.\*
- [...](./build-scripts/src/ubuntu.sh) can be installed via scripts (see below)

Basic setup:
1. `cd $PROJECT_DIR`
2. `git submodule update --init --recursive --depth 1`
3. `./build-scripts/install-deps.rb --os`
4. `source env.sh`
5. `git third-party update --all`
<!--
  of version 1.80; please, refer to [rustup docs](https://www.rust-lang.org/tools/install) for installation. Target wasm32-wasi and "host" are required. `rustup target add wasm32-wasi`
-->

### Simple

1. `./build-scripts/install-deps.rb --rust --genvm`
2. `ya-build config` (for release build pass `--preload .ci/release-conf.rb`)
3. `ninja -C build genvm/genvm/all`
4. Get `genvm-runners.zip` from [github](https://github.com/yeagerai/genvm)
5. merge `build/out` and `genvm-runners.zip`

### Full

1. `./build-scripts/install-deps.rb --rust --genvm --runners`
2. `ya-build config` (for release build pass `--preload .ci/release-conf.rb`)
3. `ninja -C build tags/all`
4. full genvm is located at `build/out`

Building
1. `./tools/ya-build/ya-build config`
  This command scraps and configures all targets (similar to CMake)
2. `ninja -C build`
  This command actually builds the project. Please, use it before every run. Also note, that it doesn't detect new files **creation**, so if you added a file (to `sdk-python/py` for instance), you may need to rerun the above command as well
3. output is located at `build/out` as a root (`bin`, `lib`, `share`)

## Running tests
As of now there are two test suites

### genvm/testdata
For `get_webpage` tests to work, one needs a compatible webdriver. There is a docker image for simplification: `bash -c 'docker run --network host $(docker build -q -t genvm/modules-webdriver -f genvm/modules/default-impl/web-funcs/webdriver.dockerfile genvm/modules/default-impl/web-funcs/)' &`

Generic steps:
```bash
### install dependencies (once)
python3 -m pip install -r genvm/testdata/runner/requirements.txt
sudo apt-get install -y wabt
### run
./genvm/testdata/runner/run.py
```

### sdk-python
```bash
### install python 3.12
curl https://pyenv.run | bash
sudo apt install libsqlite3-dev
# ^ without sqlite-dev further won't have sqlite3 required by tests
~/.pyenv/bin/pyenv install 3.12
### install poetry
python3 -m pip install poetry
poetry env use ~/.pyenv/versions/3.12.5/bin/python3.12
### install dependencies (once)
cd sdk-python
poetry install
### run tests
poetry run pytest -n auto
```
