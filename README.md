# GenVM
It is a monorepo for GenVM, which consists of the following subprojects:
- [genvm](./genvm/) itself: modified [`wasmtime`](https://wasmtime.dev) which exposes genvm-sdk-wasi implementation and does all the sandboxing work
- [sdk-rust](./sdk-rust/): rust bindings for genvm-sdk-wasi, this library is autogenerated from [witx](./genvm/src/wasi/witx/genlayer_sdk.witx)
- [sdk-python](./sdk-python/):
    - Driver for slight [RustPython](https://github.com/RustPython/RustPython) modification that allows rustpython to work in sandboxed environment and patches some pieces of code to be compatible with typing from 3.12
    - bindings for genvm-sdk-wasi:
        - raw [`genlayer.wasi`](./sdk-python/src/pyimpl.rs) wrapped in rust and it's [python interface](./sdk-python/py-stub)
        - user-firendly [`genlayer.sdk`](./sdk-python/py/) in pure python

## Building

Required tools:
- git
- python3
- ruby (tested with 3.0)
- ninja-build (or just ninja)
- cargo and rust of version 1.80; please, refer to [rustup docs](https://www.rust-lang.org/tools/install) for installation

Getting the source
1. clone the repositopry
2. `git submodule update --init --recursive`
3. `./tools/git-third-party/git-third-party update --all`
  This command will clone all third-party repositories and then apply patches to them

Download WASI sdk (v. 24 is tested)
```bash
mkdir -p build
pushd build
wget https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-24/wasi-sdk-24.0-x86_64-linux.tar.gz
# ^ note that your link may be different, refer to https://github.com/WebAssembly/wasi-sdk/releases/ for other target triples
tar -xvf wasi-sdk-24.0-x86_64-linux.tar.gz
mv wasi-sdk-24.0-x86_64-linux wasi-sdk-24
popd
```

Actually building became way too complex really fast (patching floats for software ones and so on), for convenience small generator script was introduced
1. `./tools/ya-build/ya-build config`
  This command scraps and configures all targets (similar to CMake)
2. `ninja -C build`
  This command actually builds the project. Please, use it before every run. Also note, that it doesn't detect new files **creation**, so if you added a file (to `sdk-python/py` for instance), you may need to rerun the above command as well

## Running tests
As of now there are two test suites

### genvm/testdata
For `get_webpage` tests to work, one needs
- `chrome`
- `chromedriver`
- running chrome driver `PATH="/path/to/chrome/bin:$PATH" chromedriver --port=4444 &`

In case of getting issues during installation it, refer to [ci job](./.github/workflows/tests.yaml) that does it. Note, that this driver can be ran within docker

Generic steps:
```bash
### install dependencies (once)
python3 -m pip install -r genvm/testdata/runner/requirements.txt
### run
./genvm/testdata/runner/run.py
```

### sdk-python
```bash
### install python 3.12
curl https://pyenv.run | bash
sudo apt install libsqlite3-dev
# ^ without sqlite-dev further won't have sqlite3 required by tests
~/.pyenv/bin/pyenv install 3.12
### install poetry
python3 -m pip install poetry
poetry env use ~/.pyenv/versions/3.12.5/bin/python3.12
### install dependencies (once)
cd sdk-python
poetry install
### run tests
poetry run pytest -n auto
```
