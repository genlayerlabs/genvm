name: GenVM build executor
on:
  workflow_call:
    inputs:
      preloads:
        type: string
        required: true
        description: preloads
      install_also:
        type: string
        required: true
        description: install_also
      runs_on:
        type: string
        required: true
        description: runner id
    outputs:
      artifact_name:
        value: ${{ jobs.build.outputs.artifact_name }}
      artifact_url:
        value: ${{ jobs.build.outputs.artifact_url }}
defaults:
  run:
    shell: bash -x {0}
env:
  GCS_BUCKET: "gh-af"
jobs:
  build:
    runs-on: ${{ inputs.runs_on }}
    outputs:
      artifact_name: ${{ steps.upload.outputs.basename }}
      artifact_url: ${{ steps.upload.outputs.gcs_url }}
    steps:
      - uses: actions/checkout@v4
      - run: |
          git fetch origin 'refs/tags/*:refs/tags/*'
      - name: Get source
        uses: ./.github/actions/get-src
        with:
          install_also: --genvm --rust ${{ inputs.install_also }}
          third_party: executor/third-party/wasmtime executor/third-party/wasm-tools
      - name: install tools and configure
        run: |
          cd "$GITHUB_WORKSPACE" && \
          source env.sh && \
          ./tools/ya-build/ya-build config ${{ inputs.preloads }}
      - name: build
        run: |
          cd "$GITHUB_WORKSPACE" && \
            source env.sh && \
            ninja -v -C build genvm/executor/all && \
            tree build/out && \
            pushd build/out && \
            zip -r -9 ../genvm_executor.zip * && \
            popd

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      - name: Generate upload url
        id: upload
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          DIR_NAME="genvm_executor_${GITHUB_SHA}_${TIMESTAMP}"
          echo "dirname=$DIR_NAME" >> $GITHUB_OUTPUT
          BASE_NAME="genvm_executor.zip"
          echo "basename=$BASE_NAME" >> $GITHUB_OUTPUT
          echo "gcs_url=https://storage.googleapis.com/$GCS_BUCKET/$DIR_NAME/$BASE_NAME" >> $GITHUB_OUTPUT
      - name: Upload to GCS
        uses: google-github-actions/upload-cloud-storage@v2
        with:
          path: build/${{ steps.upload.outputs.basename }}
          destination: ${{ env.GCS_BUCKET }}/${{ steps.upload.outputs.dirname }}
          parent: false
